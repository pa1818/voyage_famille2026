<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vote familial ‚Äì Destinations de voyage</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
    header { background:#4CAF50; color:white; padding:1rem; text-align:center; }
    nav { display:flex; justify-content:center; background:#333; }
    nav a { color:white; padding:1rem; text-decoration:none; }
    nav a.active { background:#4CAF50; }
    .container { padding:1rem; max-width:800px; margin:auto; }
    section { display:none; }
    section.active { display:block; }
    input, button, textarea { padding:0.5rem; margin:0.25rem 0; width:100%; }
    .proposal { background:white; padding:1rem; margin:0.5rem 0; border-radius:8px; }
    .stars span { cursor:pointer; font-size:1.5rem; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB4lCBFz5NWi5RcNY9R68T3bH-NHuhNERA",
      authDomain: "voyage-famille-2026.firebaseapp.com",
      databaseURL: "https://voyage-famille-2026-default-rtdb.firebaseio.com",
      projectId: "voyage-famille-2026",
      storageBucket: "voyage-famille-2026.appspot.com",
      messagingSenderId: "773649683368",
      appId: "1:773649683368:web:7abb3a4e2b88bd45adc39d",
      measurementId: "G-731XCK98DZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentMember = '';

    window.showPage = function(page){
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
      document.querySelector('nav a[href="#'+page+'"]').classList.add('active');
      if(page==='ranking'){ loadRanking(); }
      if(page==='profile'){ loadProposals(); }
    };

    window.addMember = async function(){
      const name = document.getElementById('memberName').value.trim();
      if(!name) return alert('Entrez un nom');
      currentMember = name;
      await set(ref(db, 'members/' + name), true);
      alert(name + ' ajout√© !');
      document.getElementById('memberName').value='';
    };

    window.addProposal = async function(){
      const title = document.getElementById('proposalTitle').value.trim();
      const args = document.getElementById('proposalArgs').value.trim();
      if(!title || !args) return alert('Titre et arguments requis');
      const proposalsSnap = await get(ref(db, 'proposals'));
      const proposals = proposalsSnap.val() || {};
      const count = Object.values(proposals).filter(p => p.author===currentMember).length;
      if(count >= 2){ alert('Vous avez d√©j√† 2 propositions'); return; }
      const id = Date.now();
      await set(ref(db, 'proposals/' + id), {id, author:currentMember, title, args});
      document.getElementById('proposalTitle').value='';
      document.getElementById('proposalArgs').value='';
      alert('Proposition ajout√©e !');
      loadProposals();
    };

    window.rateProposal = async function(proposalId, score){
      if(!currentMember) return alert('S√©lectionnez un membre');
      await set(ref(db, 'ratings/' + proposalId + '/' + currentMember), score);
      loadProposals();
      loadRanking();
    };

    async function loadProposals(){
      const container = document.getElementById('proposalsList');
      container.innerHTML='';
      const proposalsSnap = await get(ref(db, 'proposals'));
      const proposals = proposalsSnap.val() || {};
      for(const id in proposals){
        const p = proposals[id];
        const ratingsSnap = await get(ref(db, 'ratings/' + id));
        const ratings = ratingsSnap.val() || {};
        const score = ratings[currentMember] || 0;
        const div = document.createElement('div');
        div.className='proposal';
        div.innerHTML = `<strong>${p.title}</strong> par ${p.author}<br>${p.args}<br><div class='stars'>`+
                        `[1,2,3,4,5].map(i=>'<span onclick="rateProposal(`+id+`, '+i+')">'+(i<=score?'‚òÖ':'‚òÜ')+'</span>').join('')+`</div>`;
        container.appendChild(div);
      }
    }

    async function loadRanking(){
      const container = document.getElementById('rankingList');
      container.innerHTML='';
      const proposalsSnap = await get(ref(db, 'proposals'));
      const proposals = proposalsSnap.val() || {};
      const ranking = [];
      for(const id in proposals){
        const ratingsSnap = await get(ref(db, 'ratings/' + id));
        const ratings = ratingsSnap.val() || {};
        const avg = Object.values(ratings).reduce((a,b)=>a+b,0)/Math.max(1,Object.values(ratings).length);
        ranking.push({...proposals[id], avg});
      }
      ranking.sort((a,b)=>b.avg-a.avg);
      ranking.forEach(p=>{
        const div = document.createElement('div');
        div.className='proposal';
        div.innerHTML=`${p.title} par ${p.author} ‚Äì Moyenne: ${p.avg.toFixed(2)} √©toiles<br>${p.args}`;
        container.appendChild(div);
      });
    }
  </script>
</head>
<body onload="showPage('home')">
  <header>
    <h1>üèùÔ∏è Vote familial</h1>
  </header>
  <nav>
    <a href="#home" class="active" onclick="showPage('home')">üè† Maison</a>
    <a href="#profile" onclick="showPage('profile')">üë§ Profil</a>
    <a href="#ranking" onclick="showPage('ranking')">üèÜ Classement</a>
  </nav>
  <div class="container">
    <section id="home" class="active">
      <h2>Bienvenue !</h2>
      <p>Ajoutez un membre pour commencer :</p>
      <input id="memberName" placeholder="Nom du membre" />
      <button onclick="addMember()">Ajouter membre</button>
    </section>

    <section id="profile">
      <h2>Proposer une destination</h2>
      <input id="proposalTitle" placeholder="Titre de la destination" />
      <textarea id="proposalArgs" placeholder="Arguments pour la destination"></textarea>
      <button onclick="addProposal()">Ajouter proposition</button>
      <h3>Vos propositions</h3>
      <div id="proposalsList"></div>
    </section>

    <section id="ranking">
      <h2>Classement g√©n√©ral</h2>
      <div id="rankingList"></div>
    </section>
  </div>
</body>
</html>
